<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integration Test Suite - Random Question System</title>

    <!-- CryptoJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .test-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .test-card h2 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            font-size: 1.3rem;
        }

        .test-result {
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-result.pass {
            background: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }

        .test-result.fail {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }

        .test-result.info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            color: #0c5460;
        }

        .test-result.warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
        }

        .icon {
            font-size: 20px;
            font-weight: bold;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
        }

        .question-preview {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            max-height: 300px;
            overflow-y: auto;
        }

        .question-preview h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .question-preview pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .summary-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .summary-card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Integration Test Suite - Random Question System</h1>

        <div class="summary-card">
            <h2>Test Progress</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar">0%</div>
            </div>
            <div id="overallStatus"></div>
        </div>

        <div class="test-grid">
            <div class="test-card">
                <h2>üìö 1. Dependency Loading</h2>
                <div id="dependencyTests"></div>
            </div>

            <div class="test-card">
                <h2>üé≤ 2. Random Selection</h2>
                <div id="randomTests"></div>
            </div>

            <div class="test-card">
                <h2>üîê 3. Encryption Security</h2>
                <div id="encryptionTests"></div>
            </div>

            <div class="test-card">
                <h2>üìä 4. Question Distribution</h2>
                <div id="distributionTests"></div>
            </div>
        </div>

        <div class="test-card">
            <h2>üìà Test Statistics</h2>
            <div id="statsDisplay"></div>
        </div>

        <div class="test-card">
            <h2>üîç Sample Questions Preview</h2>
            <button onclick="showSampleQuestions()">Show Sample Questions</button>
            <button onclick="runMultipleRandomTests()">Run 10 Randomization Tests</button>
            <div id="sampleQuestions"></div>
        </div>

        <div class="test-card">
            <h2>‚úÖ Final Validation</h2>
            <div id="finalValidation"></div>
        </div>
    </div>

    <!-- Load Question System -->
    <script src="questions-database.js"></script>
    <script src="questions-subjective.js"></script>
    <script src="exam-integration.js"></script>

    <script>
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0
        };

        let testExamManager = null;

        // ==================== TEST UTILITIES ====================
        function addTestResult(containerId, passed, message, type = 'result') {
            const container = document.getElementById(containerId);
            const resultClass = type === 'result' ? (passed ? 'pass' : 'fail') : type;
            const icon = passed ? '‚úÖ' : (type === 'info' ? '‚ÑπÔ∏è' : (type === 'warning' ? '‚ö†Ô∏è' : '‚ùå'));

            const div = document.createElement('div');
            div.className = `test-result ${resultClass}`;
            div.innerHTML = `<span class="icon">${icon}</span><span>${message}</span>`;
            container.appendChild(div);

            if (type === 'result') {
                testResults.total++;
                if (passed) testResults.passed++;
                else testResults.failed++;
            }

            updateProgress();
        }

        function updateProgress() {
            const progress = testResults.total > 0 ?
                Math.round((testResults.passed / testResults.total) * 100) : 0;

            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = progress + '%';
            progressBar.textContent = progress + '%';

            const statusDiv = document.getElementById('overallStatus');
            statusDiv.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value">${testResults.total}</div>
                        <div class="stat-label">Total Tests</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${testResults.passed}</div>
                        <div class="stat-label">Passed</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${testResults.failed}</div>
                        <div class="stat-label">Failed</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${progress}%</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                </div>
            `;
        }

        // ==================== TEST 1: DEPENDENCY LOADING ====================
        function testDependencies() {
            console.log('üß™ Testing dependencies...');

            addTestResult('dependencyTests',
                typeof CryptoJS !== 'undefined',
                'CryptoJS library loaded');

            addTestResult('dependencyTests',
                typeof QUESTION_DATABASE !== 'undefined',
                'Question database loaded');

            addTestResult('dependencyTests',
                typeof PYTHON_SUBJECTIVE !== 'undefined',
                'Python subjective questions loaded');

            addTestResult('dependencyTests',
                typeof SQL_SUBJECTIVE !== 'undefined',
                'SQL subjective questions loaded');

            addTestResult('dependencyTests',
                typeof initializeExamSystem === 'function',
                'Exam initialization function available');

            // Merge subjective questions
            if (typeof QUESTION_DATABASE !== 'undefined') {
                QUESTION_DATABASE.pythonSubjective = PYTHON_SUBJECTIVE;
                QUESTION_DATABASE.sqlSubjective = SQL_SUBJECTIVE;

                addTestResult('dependencyTests', true,
                    'Subjective questions merged into database', 'info');
            }
        }

        // ==================== TEST 2: RANDOM SELECTION ====================
        function testRandomSelection() {
            console.log('üß™ Testing random selection...');

            try {
                testExamManager = initializeExamSystem();

                addTestResult('randomTests',
                    testExamManager !== null,
                    'Exam manager initialized');

                addTestResult('randomTests',
                    testExamManager.selectedQuestions.length === 15,
                    `Selected exactly 15 questions (got ${testExamManager.selectedQuestions.length})`);

                const mcqCount = testExamManager.selectedQuestions.filter(q => q.type === 'mcq').length;
                addTestResult('randomTests',
                    mcqCount === 10,
                    `Selected 10 objective questions (got ${mcqCount})`);

                const codingCount = testExamManager.selectedQuestions.filter(q => q.type === 'coding').length;
                addTestResult('randomTests',
                    codingCount === 5,
                    `Selected 5 subjective questions (got ${codingCount})`);

                // Check for duplicates
                const ids = testExamManager.selectedQuestions.map(q => q.id);
                const uniqueIds = new Set(ids);
                addTestResult('randomTests',
                    ids.length === uniqueIds.size,
                    `No duplicate questions (${ids.length} questions, ${uniqueIds.size} unique)`);

            } catch (error) {
                addTestResult('randomTests', false, `Error: ${error.message}`);
            }
        }

        // ==================== TEST 3: ENCRYPTION ====================
        function testEncryption() {
            console.log('üß™ Testing encryption...');

            if (!testExamManager) {
                addTestResult('encryptionTests', false, 'Exam manager not initialized');
                return;
            }

            const encryptionTest = testExamManager.verifyEncryption();
            addTestResult('encryptionTests',
                encryptionTest,
                'All questions properly encrypted');

            // Test decryption
            try {
                const firstQuestion = testExamManager.getCurrentQuestion();
                addTestResult('encryptionTests',
                    firstQuestion !== null,
                    'Progressive decryption working');

                addTestResult('encryptionTests',
                    firstQuestion.question && firstQuestion.question.length > 0,
                    'Decrypted question has content');

                addTestResult('encryptionTests',
                    firstQuestion.type === 'mcq' || firstQuestion.type === 'coding',
                    `Question type is valid (${firstQuestion.type})`);

            } catch (error) {
                addTestResult('encryptionTests', false, `Decryption error: ${error.message}`);
            }
        }

        // ==================== TEST 4: DISTRIBUTION ====================
        function testDistribution() {
            console.log('üß™ Testing distribution...');

            if (!testExamManager) {
                addTestResult('distributionTests', false, 'Exam manager not initialized');
                return;
            }

            const stats = testExamManager.getStats();

            addTestResult('distributionTests', true,
                `Total questions: ${stats.total}`, 'info');

            addTestResult('distributionTests', true,
                `Python questions: ${stats.pythonQuestions}`, 'info');

            addTestResult('distributionTests', true,
                `SQL questions: ${stats.sqlQuestions}`, 'info');

            // Check for reasonable distribution
            const pythonRatio = stats.pythonQuestions / stats.total;
            addTestResult('distributionTests',
                pythonRatio >= 0.2 && pythonRatio <= 0.8,
                `Python/SQL distribution is balanced (${Math.round(pythonRatio * 100)}% Python)`);

            // Display stats
            const statsDiv = document.getElementById('statsDisplay');
            statsDiv.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value">${stats.total}</div>
                        <div class="stat-label">Total Questions</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${stats.objective}</div>
                        <div class="stat-label">Objective (MCQ)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${stats.subjective}</div>
                        <div class="stat-label">Subjective (Coding)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${stats.pythonQuestions}</div>
                        <div class="stat-label">Python</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${stats.sqlQuestions}</div>
                        <div class="stat-label">SQL</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">${stats.current}</div>
                        <div class="stat-label">Current Index</div>
                    </div>
                </div>
            `;
        }

        // ==================== SAMPLE QUESTIONS ====================
        function showSampleQuestions() {
            if (!testExamManager) return;

            const container = document.getElementById('sampleQuestions');
            let html = '';

            // Show first 3 questions
            for (let i = 0; i < Math.min(3, testExamManager.selectedQuestions.length); i++) {
                const q = testExamManager.selectedQuestions[i];
                html += `
                    <div class="question-preview">
                        <h4>Question ${i + 1}: ${q.type.toUpperCase()} - ${q.category}</h4>
                        <p><strong>ID:</strong> ${q.id}</p>
                        <p><strong>Points:</strong> ${q.points}</p>
                        <p><strong>Question:</strong> ${q.question.substring(0, 150)}...</p>
                        ${q.type === 'mcq' ? `<p><strong>Options:</strong> ${q.options.length} choices</p>` : ''}
                        ${q.type === 'coding' ? `<p><strong>Starter Code:</strong> Available</p>` : ''}
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // ==================== MULTIPLE RANDOM TESTS ====================
        function runMultipleRandomTests() {
            const container = document.getElementById('sampleQuestions');
            container.innerHTML = '<div class="test-result info"><span class="icon">üîÑ</span><span>Running 10 randomization tests...</span></div>';

            setTimeout(() => {
                const results = [];
                const questionSets = [];

                for (let i = 0; i < 10; i++) {
                    const manager = new ExamQuestionManager();
                    manager.initializeExam();
                    const ids = manager.selectedQuestions.map(q => q.id);
                    questionSets.push(ids);

                    results.push({
                        iteration: i + 1,
                        total: manager.selectedQuestions.length,
                        mcq: manager.selectedQuestions.filter(q => q.type === 'mcq').length,
                        coding: manager.selectedQuestions.filter(q => q.type === 'coding').length,
                        python: manager.selectedQuestions.filter(q => q.category === 'python').length,
                        sql: manager.selectedQuestions.filter(q => q.category === 'sql').length,
                        ids: ids
                    });
                }

                // Check uniqueness
                const uniqueSets = new Set(questionSets.map(s => JSON.stringify(s)));

                let html = `
                    <div class="test-result ${uniqueSets.size === 10 ? 'pass' : 'warning'}">
                        <span class="icon">${uniqueSets.size === 10 ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                        <span>Generated ${uniqueSets.size} unique question sets out of 10 iterations</span>
                    </div>
                `;

                results.forEach(r => {
                    html += `
                        <div class="question-preview">
                            <h4>Iteration ${r.iteration}</h4>
                            <p><strong>Distribution:</strong> ${r.mcq} MCQ + ${r.coding} Coding = ${r.total} Total</p>
                            <p><strong>Languages:</strong> ${r.python} Python + ${r.sql} SQL</p>
                            <p><strong>Question IDs:</strong></p>
                            <div class="code-block">${r.ids.join(', ')}</div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            }, 100);
        }

        // ==================== FINAL VALIDATION ====================
        function runFinalValidation() {
            const container = document.getElementById('finalValidation');

            const allPassed = testResults.failed === 0;
            const successRate = testResults.total > 0 ?
                Math.round((testResults.passed / testResults.total) * 100) : 0;

            let html = `
                <div class="test-result ${allPassed ? 'pass' : (successRate >= 80 ? 'warning' : 'fail')}">
                    <span class="icon">${allPassed ? '‚úÖ' : (successRate >= 80 ? '‚ö†Ô∏è' : '‚ùå')}</span>
                    <span><strong>Overall Result: ${allPassed ? 'ALL TESTS PASSED' :
                        (successRate >= 80 ? 'MOSTLY PASSED' : 'TESTS FAILED')}</strong></span>
                </div>
                <div class="test-result info">
                    <span class="icon">üìä</span>
                    <span>Success Rate: ${successRate}% (${testResults.passed}/${testResults.total} tests passed)</span>
                </div>
            `;

            if (allPassed) {
                html += `
                    <div class="test-result pass">
                        <span class="icon">üéâ</span>
                        <span><strong>Integration Complete!</strong> The random question system is fully integrated and ready for production.</span>
                    </div>
                    <div class="test-result info">
                        <span class="icon">üìã</span>
                        <span>Next Steps: Open index.html and start an exam to test the full integration in the actual application.</span>
                    </div>
                `;
            } else {
                html += `
                    <div class="test-result fail">
                        <span class="icon">‚ö†Ô∏è</span>
                        <span>Some tests failed. Please review the errors above and fix the issues.</span>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // ==================== RUN ALL TESTS ====================
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Starting integration tests...');

            setTimeout(() => {
                testDependencies();
                setTimeout(() => {
                    testRandomSelection();
                    setTimeout(() => {
                        testEncryption();
                        setTimeout(() => {
                            testDistribution();
                            setTimeout(() => {
                                runFinalValidation();
                            }, 100);
                        }, 100);
                    }, 100);
                }, 100);
            }, 100);
        });
    </script>
</body>
</html>
