I need you to analyze and provide a comprehensive solution for the following complex software architecture scenario:

# SCENARIO: Enterprise Healthcare Management System

## Background
We are building a large-scale healthcare management system that needs to handle:
- Patient records (PHI/PII sensitive data)
- Appointment scheduling across 50+ hospitals
- Electronic Health Records (EHR) integration
- Billing and insurance claims processing
- Telemedicine video consultations
- Prescription management with drug interaction checking
- Lab results and imaging integration
- Staff scheduling and shift management

## Current Architecture Issues
1. Monolithic legacy system running on outdated technology
2. No proper API layer for third-party integrations
3. Database performance issues with 10M+ patient records
4. No real-time synchronization across hospitals
5. Security vulnerabilities in authentication system
6. No audit logging for HIPAA compliance
7. Mobile app frequently crashes
8. Report generation takes hours
9. No disaster recovery plan
10. High technical debt from 15 years of patches

## Requirements

### Functional Requirements
1. Patient Management
   - Create/update patient records
   - Search across all hospitals
   - Merge duplicate records
   - Track patient history
   - Family member linking
   - Insurance verification
   - Consent management
   - Portal for patients to view their records

2. Appointment System
   - Real-time availability checking
   - Multi-hospital scheduling
   - Waiting list management
   - Automated reminders (SMS/email)
   - Telemedicine integration
   - Calendar synchronization
   - Recurring appointments
   - Group appointments
   - Resource booking (equipment, rooms)

3. Clinical Workflows
   - e-Prescribing with drug interaction checking
   - Lab order management
   - Imaging (PACS) integration
   - Clinical decision support
   - Treatment plans
   - Care team coordination
   - Referral management
   - Clinical notes with templates

4. Billing & Revenue Cycle
   - Insurance eligibility verification
   - Claims submission
   - Payment processing
   - Collections management
   - Financial reporting
   - Multiple payment methods
   - Co-pay collection
   - Statement generation

### Non-Functional Requirements
1. Performance
   - Page load < 2 seconds
   - API response < 500ms (95th percentile)
   - Support 10,000 concurrent users
   - Database queries < 100ms
   - Report generation < 5 minutes

2. Security
   - HIPAA compliance
   - GDPR compliance (EU patients)
   - SOC 2 Type II certification
   - End-to-end encryption
   - Role-based access control (RBAC)
   - Multi-factor authentication
   - Audit logging all PHI access
   - Data masking for non-clinical staff
   - Penetration testing quarterly

3. Availability
   - 99.9% uptime SLA
   - Zero-downtime deployments
   - Disaster recovery (RTO: 4 hours, RPO: 1 hour)
   - Multi-region redundancy
   - Automated failover
   - Database replication

4. Scalability
   - Horizontal scaling capability
   - Handle 100M+ records
   - Process 1M appointments/day
   - Support growth to 100 hospitals
   - Auto-scaling based on load

5. Compliance
   - HIPAA Security Rule
   - HIPAA Privacy Rule
   - HITECH Act
   - GDPR (for EU patients)
   - PCI DSS (for payment processing)
   - HL7 FHIR standards
   - ICD-10 coding
   - CPT coding

## Technical Constraints
1. Must integrate with existing systems:
   - Epic EHR (HL7 v2.x and FHIR)
   - Cerner Millennium
   - Allscripts
   - athenahealth
   - Multiple lab systems (LabCorp, Quest)
   - Multiple imaging PACS systems
   - Insurance clearinghouses
   - Payment gateways (Stripe, Square)

2. Technology preferences:
   - Cloud-native (AWS or Azure)
   - Microservices architecture
   - Event-driven where appropriate
   - RESTful APIs + GraphQL
   - React for frontend
   - Mobile apps (iOS and Android)
   - Real-time data sync
   - Offline-capable mobile apps

3. Team constraints:
   - Team of 20 developers
   - 18-month timeline
   - Budget: $5M
   - Need to maintain existing system during migration
   - Phased rollout across hospitals
   - Training required for 5,000 staff members

4. Data migration:
   - 10M patient records
   - 50M appointments (historical)
   - 200M clinical documents
   - 100M billing transactions
   - Zero data loss acceptable
   - Validation required
   - Rollback plan needed

## Specific Questions to Address

1. Architecture Design
   - Recommend microservices boundaries
   - API gateway strategy
   - Service mesh: yes or no?
   - Event-driven architecture patterns
   - CQRS and Event Sourcing: where applicable?
   - Database per service or shared?
   - Synchronous vs asynchronous communication
   - How to handle distributed transactions?

2. Data Management
   - Database selection (SQL vs NoSQL vs hybrid)
   - Data partitioning strategy
   - Caching strategy (Redis, Memcached)
   - Search functionality (Elasticsearch?)
   - Master data management for patients
   - Data lake for analytics?
   - Real-time data synchronization approach
   - Handling eventual consistency

3. Security & Compliance
   - Authentication architecture (OAuth 2.0, SAML?)
   - Authorization model (RBAC, ABAC, ReBAC?)
   - Encryption at rest and in transit
   - Key management (AWS KMS, Azure Key Vault?)
   - PHI access logging and monitoring
   - Data masking and anonymization
   - Secure API design
   - Vulnerability scanning and remediation

4. Integration Architecture
   - HL7 v2.x integration approach
   - FHIR API implementation
   - Third-party integration patterns
   - API versioning strategy
   - Webhook vs polling
   - Message queue selection (Kafka, RabbitMQ, SQS?)
   - Integration testing strategy
   - Error handling and retry logic

5. DevOps & Infrastructure
   - CI/CD pipeline design
   - Infrastructure as Code (Terraform, CloudFormation?)
   - Container orchestration (Kubernetes, ECS?)
   - Monitoring and observability stack
   - Log aggregation and analysis
   - APM (Application Performance Monitoring)
   - Alerting and incident response
   - Blue-green or canary deployments?

6. Migration Strategy
   - Strangler fig pattern details
   - Data migration tools and process
   - Cutover plan for each hospital
   - Parallel run period
   - Rollback triggers and process
   - User training and change management
   - Success metrics for each phase
   - Risk mitigation strategies

7. Mobile Strategy
   - Native vs hybrid vs PWA?
   - Offline data synchronization
   - Push notification architecture
   - Mobile device management
   - Security considerations
   - App store deployment
   - Mobile backend for frontend (BFF)?
   - Performance optimization

8. Analytics & Reporting
   - Business intelligence platform
   - Real-time dashboards
   - Ad-hoc reporting capability
   - Data warehouse design
   - ETL/ELT processes
   - Machine learning use cases
   - Predictive analytics opportunities
   - HIPAA-compliant analytics

9. Testing Strategy
   - Unit testing approach and coverage targets
   - Integration testing
   - End-to-end testing
   - Performance testing
   - Security testing
   - Compliance testing
   - User acceptance testing
   - Test data management
   - Automated vs manual testing ratio

10. Cost Optimization
    - Cloud cost estimation
    - Reserved instances vs spot instances
    - Serverless opportunities
    - Data transfer cost optimization
    - Monitoring and alerting on costs
    - FinOps practices
    - Cost allocation to departments
    - Optimization recommendations

## Deliverables Expected

Please provide:
1. High-level architecture diagram (described in text)
2. Detailed microservices breakdown with responsibilities
3. Technology stack recommendations with justification
4. Database schema considerations for key services
5. API design guidelines and examples
6. Security architecture with specific controls
7. Integration patterns and sequence diagrams (described)
8. Migration roadmap with phases and milestones
9. Risk assessment and mitigation strategies
10. Development team structure and responsibilities
11. Cost breakdown and 3-year TCO estimate
12. Success metrics and KPIs to track
13. Disaster recovery and business continuity plan outline
14. Compliance checklist and validation approach
15. Performance testing strategy and benchmarks

## Additional Context

The executive team is risk-averse and wants:
- Proven technologies
- Vendor support availability
- Reference customers in healthcare
- Clear ROI within 3 years
- Minimal disruption during migration
- Comprehensive training program
- 24/7 support plan

The clinical staff wants:
- Intuitive user interface
- Fast response times
- Mobile access
- Offline capability
- Less clicking than current system
- Voice input for notes
- Smart suggestions

The IT team wants:
- Modern technology stack
- Good documentation
- Automated deployments
- Easy troubleshooting
- Proper monitoring
- Manageable complexity

## Success Criteria

The project will be considered successful when:
1. All 50 hospitals migrated with < 0.1% data errors
2. System meets all performance SLAs
3. Zero HIPAA violations
4. User satisfaction score > 8/10
5. 99.9% uptime achieved
6. Cost per transaction reduced by 30%
7. Clinical staff efficiency improved by 20%
8. Patient portal adoption > 60%
9. Mobile app rated 4.5+ stars
10. Support ticket volume < 100/week after stabilization

Please provide a comprehensive, production-ready architectural solution that addresses all of these requirements, with specific recommendations, trade-offs, and implementation guidance.
