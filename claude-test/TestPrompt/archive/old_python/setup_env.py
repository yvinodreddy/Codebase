#!/usr/bin/env python3
"""
.env Setup Helper
Generates .env file with proper configuration for the orchestration system
"""

import os
from pathlib import Path
import sys


def create_env_file(interactive=True):
    """Create .env file with user input or defaults"""

    env_path = Path(__file__).parent / ".env"

    print("=" * 80)
    print(" .ENV CONFIGURATION SETUP")
    print("=" * 80)
    print()

    if env_path.exists():
        print(f"‚ö†Ô∏è  Warning: .env file already exists at {env_path}")
        if interactive:
            response = input("Overwrite? (y/N): ").strip().lower()
            if response != 'y':
                print("Cancelled.")
                return
        else:
            print("Using existing .env file (skipping)")
            return

    # Get configuration values
    config = {}

    if interactive:
        print("\nüìã Configuration Options:")
        print("-" * 80)

        # Anthropic API Key
        current_key = os.getenv('ANTHROPIC_API_KEY', '')
        print(f"\n1. ANTHROPIC_API_KEY")
        print(f"   Current from environment: {'*' * 20 + current_key[-10:] if current_key else 'Not set'}")
        use_current = input(f"   Use current? (Y/n): ").strip().lower()

        if use_current != 'n' and current_key:
            config['ANTHROPIC_API_KEY'] = current_key
        else:
            key = input(f"   Enter API key (or leave empty): ").strip()
            config['ANTHROPIC_API_KEY'] = key

        # Azure Content Safety (optional)
        print(f"\n2. Azure Content Safety (Optional - for enhanced guardrails)")
        setup_azure = input(f"   Configure Azure Content Safety? (y/N): ").strip().lower()

        if setup_azure == 'y':
            config['CONTENT_SAFETY_ENDPOINT'] = input("   Endpoint: ").strip()
            config['CONTENT_SAFETY_KEY'] = input("   Key: ").strip()
            config['CONTENT_SAFETY_API_VERSION'] = input("   API Version [2024-09-01]: ").strip() or "2024-09-01"
        else:
            config['CONTENT_SAFETY_ENDPOINT'] = ""
            config['CONTENT_SAFETY_KEY'] = ""
            config['CONTENT_SAFETY_API_VERSION'] = "2024-09-01"

        # Guardrail settings
        print(f"\n3. Guardrail Settings")
        config['ENABLE_PROMPT_SHIELDS'] = input("   Enable prompt shields? (Y/n): ").strip().lower() != 'n'
        config['ENABLE_CONTENT_FILTERING'] = input("   Enable content filtering? (Y/n): ").strip().lower() != 'n'
        config['ENABLE_PHI_DETECTION'] = input("   Enable PHI detection? (Y/n): ").strip().lower() != 'n'

        # Confidence threshold
        print(f"\n4. Orchestration Settings")
        threshold = input("   Minimum confidence threshold [96.0]: ").strip()
        config['MIN_CONFIDENCE_THRESHOLD'] = threshold or "96.0"

        # Log level
        log_level = input("   Log level (DEBUG/INFO/WARNING/ERROR) [INFO]: ").strip().upper()
        config['LOG_LEVEL'] = log_level or "INFO"

    else:
        # Non-interactive defaults
        config = {
            'ANTHROPIC_API_KEY': os.getenv('ANTHROPIC_API_KEY', ''),
            'CONTENT_SAFETY_ENDPOINT': '',
            'CONTENT_SAFETY_KEY': '',
            'CONTENT_SAFETY_API_VERSION': '2024-09-01',
            'ENABLE_PROMPT_SHIELDS': True,
            'ENABLE_CONTENT_FILTERING': True,
            'ENABLE_PHI_DETECTION': True,
            'MIN_CONFIDENCE_THRESHOLD': '96.0',
            'LOG_LEVEL': 'INFO'
        }

    # Write .env file
    env_content = f"""# Orchestration System Environment Configuration
# Generated by setup_env.py

# ============================================================================
# CLAUDE API CONFIGURATION
# ============================================================================

# Anthropic API Key (required for --claude mode)
# Get your key at: https://console.anthropic.com/
ANTHROPIC_API_KEY={config['ANTHROPIC_API_KEY']}

# ============================================================================
# AZURE CONTENT SAFETY (Optional)
# ============================================================================

# Azure AI Content Safety endpoint and key
# Used for enhanced content filtering guardrails
CONTENT_SAFETY_ENDPOINT={config['CONTENT_SAFETY_ENDPOINT']}
CONTENT_SAFETY_KEY={config['CONTENT_SAFETY_KEY']}
CONTENT_SAFETY_API_VERSION={config['CONTENT_SAFETY_API_VERSION']}

# ============================================================================
# GUARDRAIL CONFIGURATION
# ============================================================================

# Enable/disable specific guardrail layers
ENABLE_PROMPT_SHIELDS={'true' if config['ENABLE_PROMPT_SHIELDS'] else 'false'}
ENABLE_CONTENT_FILTERING={'true' if config['ENABLE_CONTENT_FILTERING'] else 'false'}
ENABLE_PHI_DETECTION={'true' if config['ENABLE_PHI_DETECTION'] else 'false'}
MEDICAL_TERMINOLOGY_VALIDATION=true
ENABLE_GROUNDEDNESS_CHECK=true

# Guardrail thresholds
GUARDRAIL_CONTENT_THRESHOLD=2
GUARDRAIL_GROUNDEDNESS_THRESHOLD=20

# ============================================================================
# ORCHESTRATION SETTINGS
# ============================================================================

# Minimum confidence score threshold (0-100)
# Default: 96.0 (production-ready standard)
MIN_CONFIDENCE_THRESHOLD={config['MIN_CONFIDENCE_THRESHOLD']}

# Maximum refinement iterations
MAX_REFINEMENT_ITERATIONS=5

# ============================================================================
# MONITORING & LOGGING
# ============================================================================

# Log level: DEBUG, INFO, WARNING, ERROR
LOG_LEVEL={config['LOG_LEVEL']}

# Enable metrics logging
ENABLE_METRICS_LOGGING=true

# ============================================================================
# ADVANCED SETTINGS
# ============================================================================

# Token limits (managed by Claude Code automatically)
# These are informational only - actual limits set by your subscription
# CLAUDE_CODE_MAX_OUTPUT_TOKENS is set in .bashrc

# Model selection (for Claude API mode)
DEFAULT_CLAUDE_MODEL=claude-3-5-sonnet-20241022

# Performance tuning
ENABLE_PARALLEL_PROCESSING=true
CONTEXT_AUTO_COMPACTION=true

# ============================================================================
# NOTES
# ============================================================================

# 1. The ANTHROPIC_API_KEY is also set in .bashrc for global access
# 2. This .env file is loaded by the orchestration system
# 3. Command-line arguments override these settings
# 4. See UNIVERSAL_USAGE_GUIDE.md for complete documentation
"""

    # Write file
    with open(env_path, 'w') as f:
        f.write(env_content)

    print(f"\n‚úÖ .env file created successfully at: {env_path}")
    print(f"\nConfiguration:")
    print(f"  - Anthropic API Key: {'Set' if config['ANTHROPIC_API_KEY'] else 'Not set'}")
    print(f"  - Azure Content Safety: {'Configured' if config['CONTENT_SAFETY_ENDPOINT'] else 'Not configured'}")
    print(f"  - Guardrails: {'Enabled' if config['ENABLE_PROMPT_SHIELDS'] else 'Disabled'}")
    print(f"  - Min Confidence: {config['MIN_CONFIDENCE_THRESHOLD']}%")
    print(f"  - Log Level: {config['LOG_LEVEL']}")

    print(f"\nüìö Next steps:")
    print(f"  1. Review the .env file: cat {env_path}")
    print(f"  2. Read the usage guide: cat UNIVERSAL_USAGE_GUIDE.md")
    print(f"  3. Test the system: orchestrate \"test prompt\"")
    print(f"  4. Try ULTRATHINK: ultrathink \"your task\"")
    print()


def show_current_config():
    """Display current environment configuration"""
    print("=" * 80)
    print(" CURRENT CONFIGURATION")
    print("=" * 80)
    print()

    env_vars = [
        'ANTHROPIC_API_KEY',
        'CONTENT_SAFETY_ENDPOINT',
        'CONTENT_SAFETY_KEY',
        'ENABLE_PROMPT_SHIELDS',
        'ENABLE_CONTENT_FILTERING',
        'ENABLE_PHI_DETECTION',
        'LOG_LEVEL',
        'ORCHESTRATION_HOME',
        'CLAUDE_CODE_MAX_OUTPUT_TOKENS'
    ]

    for var in env_vars:
        value = os.getenv(var, 'Not set')
        if 'KEY' in var or 'SAFETY' in var:
            # Mask sensitive values
            if value and value != 'Not set':
                value = '*' * 20 + value[-10:]
        print(f"{var:35} = {value}")

    print()

    # Check .env file
    env_path = Path(__file__).parent / ".env"
    if env_path.exists():
        print(f"‚úÖ .env file exists: {env_path}")
    else:
        print(f"‚ö†Ô∏è  .env file not found: {env_path}")
        print(f"   Run: python setup_env.py --interactive")

    print()


def main():
    import argparse

    parser = argparse.ArgumentParser(
        description="Setup .env file for orchestration system",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  python setup_env.py --interactive    # Interactive setup
  python setup_env.py --quick          # Quick setup with defaults
  python setup_env.py --show           # Show current configuration
        """
    )

    parser.add_argument(
        '--interactive', '-i',
        action='store_true',
        help='Interactive configuration (prompts for values)'
    )

    parser.add_argument(
        '--quick', '-q',
        action='store_true',
        help='Quick setup with defaults (non-interactive)'
    )

    parser.add_argument(
        '--show', '-s',
        action='store_true',
        help='Show current configuration'
    )

    args = parser.parse_args()

    if args.show:
        show_current_config()
    elif args.interactive:
        create_env_file(interactive=True)
    elif args.quick:
        create_env_file(interactive=False)
    else:
        # Default to interactive
        create_env_file(interactive=True)


if __name__ == "__main__":
    main()
