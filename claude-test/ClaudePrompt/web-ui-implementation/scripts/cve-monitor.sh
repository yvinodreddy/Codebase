#!/bin/bash

################################################################################
# CVE MONITORING SCRIPT - Production Grade
#
# SECURITY: Automated vulnerability scanning and alerting
# - Scans npm dependencies for known vulnerabilities
# - Checks NVD (National Vulnerability Database)
# - Generates detailed reports
# - Alerts on high/critical vulnerabilities
#
# Usage: ./scripts/cve-monitor.sh
# Schedule: Run weekly (recommended: Sunday 2 AM)
#   crontab -e
#   0 2 * * 0 /path/to/cve-monitor.sh
################################################################################

set -e  # Exit on error

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
REPORTS_DIR="$PROJECT_DIR/security-reports"
DATE=$(date +%Y%m%d_%H%M%S)
REPORT_FILE="$REPORTS_DIR/cve-report-$DATE.json"

# Create reports directory
mkdir -p "$REPORTS_DIR"

echo -e "${BLUE}================================${NC}"
echo -e "${BLUE}CVE MONITORING SCAN STARTED${NC}"
echo -e "${BLUE}================================${NC}"
echo -e "Date: $(date)"
echo -e "Report: $REPORT_FILE"
echo ""

################################################################################
# 1. NPM AUDIT SCAN
################################################################################
echo -e "${BLUE}[1/4] Running npm audit...${NC}"
cd "$PROJECT_DIR"

# Run npm audit and save results
npm audit --json > "$REPORTS_DIR/npm-audit-$DATE.json" 2>&1 || true

# Parse npm audit results
CRITICAL=$(npm audit --json 2>/dev/null | jq '.metadata.vulnerabilities.critical // 0')
HIGH=$(npm audit --json 2>/dev/null | jq '.metadata.vulnerabilities.high // 0')
MODERATE=$(npm audit --json 2>/dev/null | jq '.metadata.vulnerabilities.moderate // 0')
LOW=$(npm audit --json 2>/dev/null | jq '.metadata.vulnerabilities.low // 0')
TOTAL=$(npm audit --json 2>/dev/null | jq '.metadata.vulnerabilities.total // 0')

echo -e "  Critical: ${RED}$CRITICAL${NC}"
echo -e "  High:     ${YELLOW}$HIGH${NC}"
echo -e "  Moderate: $MODERATE"
echo -e "  Low:      $LOW"
echo -e "  Total:    $TOTAL"
echo ""

################################################################################
# 2. CHECK FOR OUTDATED PACKAGES
################################################################################
echo -e "${BLUE}[2/4] Checking for outdated packages...${NC}"

# Install npm-check-updates if not present
if ! command -v ncu &> /dev/null; then
    echo "  Installing npm-check-updates..."
    npm install -g npm-check-updates
fi

# Check for updates
ncu --json > "$REPORTS_DIR/outdated-$DATE.json" 2>&1 || true
OUTDATED_COUNT=$(ncu --json 2>/dev/null | jq 'length')
echo -e "  Outdated packages: $OUTDATED_COUNT"
echo ""

################################################################################
# 3. SECURITY BEST PRACTICES CHECK
################################################################################
echo -e "${BLUE}[3/4] Security best practices check...${NC}"

# Check for common security issues
SECURITY_ISSUES=0

# Check for .env files
if [ -f "$PROJECT_DIR/.env" ]; then
    echo -e "  ${YELLOW}⚠ WARNING: .env file found - ensure it's in .gitignore${NC}"
    ((SECURITY_ISSUES++))
fi

# Check for exposed secrets in code
if grep -r "sk-ant-" "$PROJECT_DIR/src" &>/dev/null; then
    echo -e "  ${RED}✗ CRITICAL: API keys found in source code!${NC}"
    ((SECURITY_ISSUES++))
fi

# Check for TODO security items
TODO_COUNT=$(grep -r "TODO.*SECURITY" "$PROJECT_DIR/src" 2>/dev/null | wc -l || echo 0)
if [ "$TODO_COUNT" -gt 0 ]; then
    echo -e "  ${YELLOW}⚠ WARNING: $TODO_COUNT security TODO items found${NC}"
fi

# Check for insecure dependencies
INSECURE_DEPS=$(grep -E "(eval|Function|require.*user)" "$PROJECT_DIR"/src/**/*.{ts,tsx,js,jsx} 2>/dev/null | wc -l || echo 0)
if [ "$INSECURE_DEPS" -gt 0 ]; then
    echo -e "  ${YELLOW}⚠ WARNING: $INSECURE_DEPS potentially insecure code patterns${NC}"
fi

echo -e "  Security issues found: $SECURITY_ISSUES"
echo ""

################################################################################
# 4. GENERATE SUMMARY REPORT
################################################################################
echo -e "${BLUE}[4/4] Generating summary report...${NC}"

# Create JSON summary
cat > "$REPORT_FILE" <<EOF
{
  "timestamp": "$(date -Iseconds)",
  "scan_type": "automated_weekly",
  "npm_audit": {
    "critical": $CRITICAL,
    "high": $HIGH,
    "moderate": $MODERATE,
    "low": $LOW,
    "total": $TOTAL
  },
  "outdated_packages": $OUTDATED_COUNT,
  "security_issues": $SECURITY_ISSUES,
  "reports": {
    "npm_audit": "$REPORTS_DIR/npm-audit-$DATE.json",
    "outdated": "$REPORTS_DIR/outdated-$DATE.json",
    "summary": "$REPORT_FILE"
  }
}
EOF

echo -e "  Report saved: $REPORT_FILE"
echo ""

################################################################################
# 5. DETERMINE ACTION REQUIRED
################################################################################
echo -e "${BLUE}================================${NC}"
echo -e "${BLUE}SCAN COMPLETE${NC}"
echo -e "${BLUE}================================${NC}"

if [ "$CRITICAL" -gt 0 ]; then
    echo -e "${RED}✗ CRITICAL VULNERABILITIES FOUND: $CRITICAL${NC}"
    echo -e "${RED}  ACTION REQUIRED: Fix within 24 hours${NC}"
    EXIT_CODE=2
elif [ "$HIGH" -gt 0 ]; then
    echo -e "${YELLOW}⚠ HIGH VULNERABILITIES FOUND: $HIGH${NC}"
    echo -e "${YELLOW}  ACTION REQUIRED: Fix within 7 days${NC}"
    EXIT_CODE=1
elif [ "$MODERATE" -gt 0 ] || [ "$SECURITY_ISSUES" -gt 0 ]; then
    echo -e "${YELLOW}⚠ MODERATE ISSUES FOUND${NC}"
    echo -e "${YELLOW}  ACTION RECOMMENDED: Review and fix${NC}"
    EXIT_CODE=0
else
    echo -e "${GREEN}✓ NO CRITICAL OR HIGH VULNERABILITIES${NC}"
    echo -e "${GREEN}  System is secure${NC}"
    EXIT_CODE=0
fi

echo ""
echo -e "Full report: $REPORT_FILE"
echo -e "To fix issues: npm audit fix"
echo -e "To update packages: ncu -u && npm install"
echo ""

################################################################################
# 6. OPTIONAL: SEND ALERTS
################################################################################
# Uncomment and configure for email/Slack alerts

# if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
#     # Email alert
#     # echo "Critical vulnerabilities found. See $REPORT_FILE" | mail -s "Security Alert" admin@example.com
#
#     # Slack webhook alert
#     # curl -X POST -H 'Content-type: application/json' \
#     #   --data "{\"text\":\"Security Alert: $CRITICAL critical, $HIGH high vulnerabilities\"}" \
#     #   YOUR_SLACK_WEBHOOK_URL
# fi

exit $EXIT_CODE
