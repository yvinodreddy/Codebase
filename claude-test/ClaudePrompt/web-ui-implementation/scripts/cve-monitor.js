#!/usr/bin/env node

/**
 * CVE MONITORING SCRIPT - Production Grade (Node.js version)
 *
 * SECURITY: Automated vulnerability scanning and alerting
 * - Scans npm dependencies for known vulnerabilities
 * - Checks for outdated packages
 * - Generates detailed reports
 * - Alerts on high/critical vulnerabilities
 *
 * Usage: node scripts/cve-monitor.js
 * Schedule: Run weekly (recommended: Sunday 2 AM)
 *   crontab -e
 *   0 2 * * 0 node /path/to/cve-monitor.js
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

// Colors for output
const colors = {
  reset: '\x1b[0m',
  red: '\x1b[0;31m',
  yellow: '\x1b[1;33m',
  green: '\x1b[0;32m',
  blue: '\x1b[0;34m'
};

// Configuration
const scriptDir = __dirname;
const projectDir = path.dirname(scriptDir);
const reportsDir = path.join(projectDir, 'security-reports');
const date = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0] + '_' +
             new Date().toTimeString().split(' ')[0].replace(/:/g, '');
const reportFile = path.join(reportsDir, `cve-report-${date}.json`);

// Create reports directory
if (!fs.existsSync(reportsDir)) {
  fs.mkdirSync(reportsDir, { recursive: true });
}

console.log(`${colors.blue}================================${colors.reset}`);
console.log(`${colors.blue}CVE MONITORING SCAN STARTED${colors.reset}`);
console.log(`${colors.blue}================================${colors.reset}`);
console.log(`Date: ${new Date().toString()}`);
console.log(`Report: ${reportFile}`);
console.log('');

// Store results
let vulnerabilities = {
  critical: 0,
  high: 0,
  moderate: 0,
  low: 0,
  total: 0
};
let outdatedCount = 0;
let securityIssues = 0;

/**
 * STAGE 1: NPM AUDIT SCAN
 */
console.log(`${colors.blue}[1/4] Running npm audit...${colors.reset}`);
try {
  const auditOutput = execSync('npm audit --json', {
    cwd: projectDir,
    encoding: 'utf-8',
    stdio: ['pipe', 'pipe', 'pipe']
  });

  // Save full audit results
  const auditFile = path.join(reportsDir, `npm-audit-${date}.json`);
  fs.writeFileSync(auditFile, auditOutput);

  // Parse results
  try {
    const auditData = JSON.parse(auditOutput);
    if (auditData.metadata && auditData.metadata.vulnerabilities) {
      vulnerabilities.critical = auditData.metadata.vulnerabilities.critical || 0;
      vulnerabilities.high = auditData.metadata.vulnerabilities.high || 0;
      vulnerabilities.moderate = auditData.metadata.vulnerabilities.moderate || 0;
      vulnerabilities.low = auditData.metadata.vulnerabilities.low || 0;
      vulnerabilities.total = auditData.metadata.vulnerabilities.total || 0;
    }
  } catch (parseError) {
    console.log('  Warning: Could not parse audit output');
  }
} catch (error) {
  // npm audit exits with non-zero if vulnerabilities found
  // Try to parse stderr for results
  if (error.stdout) {
    try {
      const auditData = JSON.parse(error.stdout);
      if (auditData.metadata && auditData.metadata.vulnerabilities) {
        vulnerabilities.critical = auditData.metadata.vulnerabilities.critical || 0;
        vulnerabilities.high = auditData.metadata.vulnerabilities.high || 0;
        vulnerabilities.moderate = auditData.metadata.vulnerabilities.moderate || 0;
        vulnerabilities.low = auditData.metadata.vulnerabilities.low || 0;
        vulnerabilities.total = auditData.metadata.vulnerabilities.total || 0;
      }

      // Save the output
      const auditFile = path.join(reportsDir, `npm-audit-${date}.json`);
      fs.writeFileSync(auditFile, error.stdout);
    } catch (parseError) {
      console.log('  Warning: Could not parse audit output from error');
    }
  }
}

console.log(`  Critical: ${colors.red}${vulnerabilities.critical}${colors.reset}`);
console.log(`  High:     ${colors.yellow}${vulnerabilities.high}${colors.reset}`);
console.log(`  Moderate: ${vulnerabilities.moderate}`);
console.log(`  Low:      ${vulnerabilities.low}`);
console.log(`  Total:    ${vulnerabilities.total}`);
console.log('');

/**
 * STAGE 2: CHECK FOR OUTDATED PACKAGES
 */
console.log(`${colors.blue}[2/4] Checking for outdated packages...${colors.reset}`);
try {
  const ncuOutput = execSync('ncu --jsonUpgraded', {
    cwd: projectDir,
    encoding: 'utf-8',
    stdio: ['pipe', 'pipe', 'pipe']
  });

  // Save outdated packages
  const outdatedFile = path.join(reportsDir, `outdated-${date}.json`);
  fs.writeFileSync(outdatedFile, ncuOutput);

  // Count outdated packages
  try {
    const outdatedData = JSON.parse(ncuOutput);
    outdatedCount = Object.keys(outdatedData).length;
  } catch (parseError) {
    console.log('  Warning: Could not parse outdated packages output');
  }
} catch (error) {
  // ncu might not be installed or might error
  console.log('  Warning: Could not check for outdated packages');
  if (error.stdout) {
    try {
      const outdatedData = JSON.parse(error.stdout);
      outdatedCount = Object.keys(outdatedData).length;
      const outdatedFile = path.join(reportsDir, `outdated-${date}.json`);
      fs.writeFileSync(outdatedFile, error.stdout);
    } catch (parseError) {
      // Ignore
    }
  }
}

console.log(`  Outdated packages: ${outdatedCount}`);
console.log('');

/**
 * STAGE 3: SECURITY BEST PRACTICES CHECK
 */
console.log(`${colors.blue}[3/4] Security best practices check...${colors.reset}`);

// Check for .env files
const envFile = path.join(projectDir, '.env');
if (fs.existsSync(envFile)) {
  console.log(`  ${colors.yellow}⚠ WARNING: .env file found - ensure it's in .gitignore${colors.reset}`);
  securityIssues++;
}

// Check for exposed secrets in code
try {
  const srcDir = path.join(projectDir, 'src');
  if (fs.existsSync(srcDir)) {
    const grepResult = execSync('grep -r "sk-ant-" src/', {
      cwd: projectDir,
      encoding: 'utf-8'
    });
    if (grepResult) {
      console.log(`  ${colors.red}✗ CRITICAL: API keys found in source code!${colors.reset}`);
      securityIssues++;
    }
  }
} catch (error) {
  // grep exits with 1 if no matches (which is good)
  // Only count as issue if exit code is not 1
  if (error.status !== 1) {
    console.log('  Warning: Could not scan for exposed secrets');
  }
}

// Check for TODO security items
try {
  const todoResult = execSync('grep -r "TODO.*SECURITY" src/ 2>/dev/null || echo ""', {
    cwd: projectDir,
    encoding: 'utf-8'
  });
  const todoCount = todoResult.trim().split('\n').filter(line => line.length > 0).length;
  if (todoCount > 0) {
    console.log(`  ${colors.yellow}⚠ WARNING: ${todoCount} security TODO items found${colors.reset}`);
  }
} catch (error) {
  // Ignore
}

console.log(`  Security issues found: ${securityIssues}`);
console.log('');

/**
 * STAGE 4: GENERATE SUMMARY REPORT
 */
console.log(`${colors.blue}[4/4] Generating summary report...${colors.reset}`);

const summaryReport = {
  timestamp: new Date().toISOString(),
  scan_type: 'automated_weekly',
  npm_audit: {
    critical: vulnerabilities.critical,
    high: vulnerabilities.high,
    moderate: vulnerabilities.moderate,
    low: vulnerabilities.low,
    total: vulnerabilities.total
  },
  outdated_packages: outdatedCount,
  security_issues: securityIssues,
  reports: {
    npm_audit: path.join(reportsDir, `npm-audit-${date}.json`),
    outdated: path.join(reportsDir, `outdated-${date}.json`),
    summary: reportFile
  }
};

fs.writeFileSync(reportFile, JSON.stringify(summaryReport, null, 2));
console.log(`  Report saved: ${reportFile}`);
console.log('');

/**
 * STAGE 5: DETERMINE ACTION REQUIRED
 */
console.log(`${colors.blue}================================${colors.reset}`);
console.log(`${colors.blue}SCAN COMPLETE${colors.reset}`);
console.log(`${colors.blue}================================${colors.reset}`);

let exitCode = 0;

if (vulnerabilities.critical > 0) {
  console.log(`${colors.red}✗ CRITICAL VULNERABILITIES FOUND: ${vulnerabilities.critical}${colors.reset}`);
  console.log(`${colors.red}  ACTION REQUIRED: Fix within 24 hours${colors.reset}`);
  exitCode = 2;
} else if (vulnerabilities.high > 0) {
  console.log(`${colors.yellow}⚠ HIGH VULNERABILITIES FOUND: ${vulnerabilities.high}${colors.reset}`);
  console.log(`${colors.yellow}  ACTION REQUIRED: Fix within 7 days${colors.reset}`);
  exitCode = 1;
} else if (vulnerabilities.moderate > 0 || securityIssues > 0) {
  console.log(`${colors.yellow}⚠ MODERATE ISSUES FOUND${colors.reset}`);
  console.log(`${colors.yellow}  ACTION RECOMMENDED: Review and fix${colors.reset}`);
  exitCode = 0;
} else {
  console.log(`${colors.green}✓ NO CRITICAL OR HIGH VULNERABILITIES${colors.reset}`);
  console.log(`${colors.green}  System is secure${colors.reset}`);
  exitCode = 0;
}

console.log('');
console.log(`Full report: ${reportFile}`);
console.log('To fix issues: npm audit fix');
console.log('To update packages: ncu -u && npm install');
console.log('');

process.exit(exitCode);
