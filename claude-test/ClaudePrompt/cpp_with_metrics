#!/bin/bash
#
# cpp_with_metrics - Enhanced cpp wrapper with automatic metrics tracking
#
# This script wraps the regular cpp command and automatically captures,
# displays, and logs performance metrics including:
# - Context usage (tokens and percentage)
# - Confidence scores
# - Execution time
# - Agent allocation
# - Iteration counts
#
# Usage: Same as regular cpp
#   ./cpp_with_metrics "your prompt" -v
#   ./cpp_with_metrics --file prompt.txt
#

# Ensure we're in the correct directory
SCRIPT_DIR="/home/user01/claude-test/ClaudePrompt"
cd "$SCRIPT_DIR" || exit 1

# Configuration
CPP_COMMAND="$SCRIPT_DIR/cpp"
METRICS_CSV="$SCRIPT_DIR/logs/metrics.csv"
TEMP_OUTPUT=$(mktemp)

# Ensure logs directory exists
mkdir -p "$SCRIPT_DIR/logs"

# Initialize CSV if it doesn't exist
if [[ ! -f "$METRICS_CSV" ]]; then
    echo "Timestamp,Prompt,Agents,Context_Tokens,Context_Pct,Iterations,Confidence,Time_Sec" > "$METRICS_CSV"
fi

# Capture start time
START_TIME=$(date +%s.%N)
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

# Extract prompt from arguments for logging
PROMPT_ARG=""
for arg in "$@"; do
    if [[ ! "$arg" =~ ^- ]]; then
        PROMPT_ARG="$arg"
        break
    fi
done

# Truncate prompt for CSV (max 50 chars)
PROMPT_SHORT="${PROMPT_ARG:0:50}"
if [[ ${#PROMPT_ARG} -gt 50 ]]; then
    PROMPT_SHORT="${PROMPT_SHORT}..."
fi

# Execute cpp and capture output
echo "Executing cpp with metrics tracking..."
echo ""

"$CPP_COMMAND" "$@" 2>&1 | tee "$TEMP_OUTPUT"

EXIT_CODE=${PIPESTATUS[0]}

# Capture end time
END_TIME=$(date +%s.%N)
ELAPSED=$(echo "$END_TIME - $START_TIME" | bc -l)
ELAPSED_FORMATTED=$(printf "%.1f" "$ELAPSED")

# Parse metrics from output
# These patterns match the verbose output from ultrathink.py

# Extract context usage - look for patterns like "[VERBOSE] Context: 1,234 tokens (0.6%)"
CONTEXT_TOKENS=$(grep -oP '\[VERBOSE\].*?Context.*?:\s*\K[\d,]+(?=\s*tokens)' "$TEMP_OUTPUT" | tail -1 | tr -d ',')
CONTEXT_PCT=$(grep -oP '\[VERBOSE\].*?Context.*?:\s*[\d,]+\s*tokens\s*\(\K[\d.]+' "$TEMP_OUTPUT" | tail -1)

# Extract agent allocation - look for patterns like "[VERBOSE] Agents: 25/500"
AGENTS=$(grep -oP '\[VERBOSE\].*?Agents.*?:\s*\K\d+/\d+' "$TEMP_OUTPUT" | tail -1)

# Extract iterations - look for patterns like "[VERBOSE] Iterations: 1"
ITERATIONS=$(grep -oP '\[VERBOSE\].*?Iterations.*?:\s*\K\d+' "$TEMP_OUTPUT" | tail -1)

# Extract confidence - look for patterns like "[VERBOSE] Confidence: 99.3%" or "Confidence: 100%"
CONFIDENCE=$(grep -oP '\[VERBOSE\].*?Confidence.*?:\s*\K[\d.]+' "$TEMP_OUTPUT" | tail -1)

# Default values if extraction failed
CONTEXT_TOKENS=${CONTEXT_TOKENS:-0}
CONTEXT_PCT=${CONTEXT_PCT:-0.0}
AGENTS=${AGENTS:-"N/A"}
ITERATIONS=${ITERATIONS:-0}
CONFIDENCE=${CONFIDENCE:-0.0}

# Determine context status indicator
CONTEXT_INDICATOR="ðŸŸ¢ OPTIMAL"
if (( $(echo "$CONTEXT_PCT >= 95" | bc -l) )); then
    CONTEXT_INDICATOR="ðŸ”´ CRITICAL"
elif (( $(echo "$CONTEXT_PCT >= 85" | bc -l) )); then
    CONTEXT_INDICATOR="ðŸŸ¡ WARNING"
elif (( $(echo "$CONTEXT_PCT >= 50" | bc -l) )); then
    CONTEXT_INDICATOR="âœ… EFFICIENT"
fi

# Determine confidence indicator
CONFIDENCE_INDICATOR="âœ…"
if (( $(echo "$CONFIDENCE < 95" | bc -l) )); then
    CONFIDENCE_INDICATOR="âš ï¸"
elif (( $(echo "$CONFIDENCE >= 99" | bc -l) )); then
    CONFIDENCE_INDICATOR="âœ…"
fi

# Display metrics box
echo ""
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ ðŸ“Š EXECUTION METRICS                                               â”‚"
echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
if [[ -n "$PROMPT_SHORT" ]]; then
    printf "â”‚ %-66s â”‚\n" "Prompt: \"$PROMPT_SHORT\""
    echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
fi
printf "â”‚ %-66s â”‚\n" "Agents: $AGENTS"

# Format context line with proper spacing
if [[ $CONTEXT_TOKENS -gt 0 ]]; then
    CONTEXT_TOKENS_FORMATTED=$(printf "%'d" "$CONTEXT_TOKENS" 2>/dev/null || echo "$CONTEXT_TOKENS")
    CONTEXT_LINE=$(printf "Context: %s tokens (%.1f%%)  %s" "$CONTEXT_TOKENS_FORMATTED" "$CONTEXT_PCT" "$CONTEXT_INDICATOR")
else
    CONTEXT_LINE="Context: N/A"
fi
printf "â”‚ %-66s â”‚\n" "$CONTEXT_LINE"

printf "â”‚ %-66s â”‚\n" "Iterations: $ITERATIONS"
printf "â”‚ %-66s â”‚\n" "Confidence: ${CONFIDENCE}%  $CONFIDENCE_INDICATOR"
printf "â”‚ %-66s â”‚\n" "Time: ${ELAPSED_FORMATTED}s"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"

# Display warning if context is high
if (( $(echo "$CONTEXT_PCT >= 85" | bc -l) )); then
    echo ""
    echo "âš ï¸  WARNING: Context usage above 85% may affect accuracy"
    echo "   Recommendation: Simplify prompt or use task chunking"
fi

# Log to CSV
echo "\"$TIMESTAMP\",\"$PROMPT_SHORT\",$AGENTS,$CONTEXT_TOKENS,$CONTEXT_PCT,$ITERATIONS,$CONFIDENCE,$ELAPSED_FORMATTED" >> "$METRICS_CSV"

# Cleanup
rm -f "$TEMP_OUTPUT"

# Exit with the same code as cpp
exit $EXIT_CODE
