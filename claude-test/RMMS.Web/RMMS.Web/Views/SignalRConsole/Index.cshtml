@model List<RMMS.Web.Controllers.Phase4.SignalRMessage>
@{
    ViewData["Title"] = "SignalR Console & Monitoring";
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-broadcast-tower"></i> SignalR Console & Monitoring</h2>
            <p class="text-muted">Real-time messaging console and SignalR connection monitoring</p>
        </div>
    </div>

    <!-- SYSTEM STATUS -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card bg-@ViewBag.StatusClass text-white">
                <div class="card-body text-center">
                    <h3>
                        <i class="fas fa-signal"></i> SignalR System Status: @ViewBag.SystemStatus
                    </h3>
                    <p class="mb-0">
                        Active Connections: @ViewBag.ActiveConnections | Total Messages: @ViewBag.TotalMessagesSent | Last Message: @ViewBag.LastMessageTime
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- CONNECTION & MESSAGE STATISTICS -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-users"></i> Active Connections</h5>
                    <h2>@ViewBag.ActiveConnections</h2>
                    <small>Currently connected</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-envelope"></i> Total Messages</h5>
                    <h2>@ViewBag.TotalMessagesSent</h2>
                    <small>All time</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-list"></i> Messages in Log</h5>
                    <h2>@ViewBag.MessagesInLog</h2>
                    <small>Recent history</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-chart-line"></i> Messages/Hour</h5>
                    <h2>@ViewBag.MessagesPerHour</h2>
                    <small>Average rate</small>
                </div>
            </div>
        </div>
    </div>

    <!-- MESSAGE TYPE BREAKDOWN -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">Messages (24h)</h6>
                    <h3 class="text-primary">@ViewBag.Messages24Hours</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">Broadcast Messages</h6>
                    <h3 class="text-success">@ViewBag.BroadcastMessages</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">Direct Messages</h6>
                    <h3 class="text-info">@ViewBag.DirectMessages</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">Group Messages</h6>
                    <h3 class="text-warning">@ViewBag.GroupMessages</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- MESSAGE TYPE INFO -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">Message Type Statistics</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Message Types: <span class="badge bg-primary">@ViewBag.MessageTypes</span></h5>
                        </div>
                        <div class="col-md-6">
                            <h5>Top Type: <span class="badge bg-success">@ViewBag.TopMessageType</span></h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ACTION BUTTONS -->
    <div class="row mb-3">
        <div class="col-12">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#broadcastModal">
                <i class="fas fa-bullhorn"></i> Broadcast Message
            </button>
            <form method="post" asp-action="SimulateConnection" style="display: inline;">
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-plug"></i> Simulate Connection
                </button>
            </form>
            <form method="post" asp-action="SimulateDisconnection" style="display: inline;">
                <button type="submit" class="btn btn-warning">
                    <i class="fas fa-unlink"></i> Simulate Disconnection
                </button>
            </form>
            <a href="@Url.Action("GetStatistics", "SignalRConsole")" class="btn btn-info" target="_blank">
                <i class="fas fa-chart-bar"></i> View Statistics
            </a>
            <a href="@Url.Action("GetMessageTrace", "SignalRConsole")" class="btn btn-secondary" target="_blank">
                <i class="fas fa-stream"></i> Message Trace
            </a>
            <form method="post" asp-action="ClearMessageLog" style="display: inline;" onsubmit="return confirm('Clear all messages?');">
                <button type="submit" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Clear Log
                </button>
            </form>
        </div>
    </div>

    <!-- MESSAGE LOG TABLE -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-comments"></i> Recent Messages (@Model.Count)</h5>
                </div>
                <div class="card-body">
                    @if (Model.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Type</th>
                                        <th>Sender</th>
                                        <th>Recipient</th>
                                        <th>Content</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var message in Model)
                                    {
                                        var typeClass = message.Type == "Broadcast" ? "primary"
                                                      : message.Type == "Direct" ? "info"
                                                      : "warning";
                                        <tr>
                                            <td>@message.Timestamp.ToString("HH:mm:ss")</td>
                                            <td><span class="badge bg-@typeClass">@message.Type</span></td>
                                            <td><strong>@message.Sender</strong></td>
                                            <td>@(message.Recipient ?? "All")</td>
                                            <td>@message.Content</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> No messages in log. Send your first broadcast message!
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Broadcast Message Modal -->
<div class="modal fade" id="broadcastModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-action="BroadcastMessage">
                <div class="modal-header">
                    <h5 class="modal-title">Broadcast Message to All Connections</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Message <span class="text-danger">*</span></label>
                        <textarea name="message" class="form-control" rows="4" required placeholder="Enter your broadcast message..."></textarea>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> This message will be sent to all connected SignalR clients.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-bullhorn"></i> Broadcast
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}
