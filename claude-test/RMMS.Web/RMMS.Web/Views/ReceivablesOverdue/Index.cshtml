@model List<RMMS.Models.ReceivableOverdue>
@{
    ViewData["Title"] = "Receivables Overdue";
    var totalReceivable = Model?.Sum(x => x.BalanceDue) ?? 0;
    var totalOverdue = Model?.Where(x => x.DaysOverdue > 0).Sum(x => x.BalanceDue) ?? 0;
    var overdueCount = Model?.Count(x => x.DaysOverdue > 0) ?? 0;
    var criticalCount = Model?.Count(x => x.DaysOverdue > 60) ?? 0;
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="ms-card ms-stat-card">
                <div class="ms-card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="ms-text-muted mb-2">Total Receivables</h6>
                            <h3 class="ms-text-primary mb-0">@(Model?.Count ?? 0)</h3>
                        </div>
                        <div class="ms-stat-icon" style="background: #E3F2FD;">
                            <i class="fas fa-receipt" style="color: #0078D4;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="ms-card ms-stat-card">
                <div class="ms-card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="ms-text-muted mb-2">Total Amount Due</h6>
                            <h3 class="ms-text-warning mb-0">₹@totalReceivable.ToString("N0")</h3>
                        </div>
                        <div class="ms-stat-icon" style="background: #FFF3E0;">
                            <i class="fas fa-hand-holding-usd" style="color: #FFC107;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="ms-card ms-stat-card">
                <div class="ms-card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="ms-text-muted mb-2">Overdue Amount</h6>
                            <h3 class="ms-text-danger mb-0">₹@totalOverdue.ToString("N0")</h3>
                            <small class="ms-text-muted">@overdueCount items</small>
                        </div>
                        <div class="ms-stat-icon" style="background: #FFEBEE;">
                            <i class="fas fa-exclamation-triangle" style="color: #DC3545;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="ms-card ms-stat-card">
                <div class="ms-card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="ms-text-muted mb-2">Critical (>60 days)</h6>
                            <h3 class="ms-text-danger mb-0">@criticalCount</h3>
                        </div>
                        <div class="ms-stat-icon" style="background: #FFEBEE;">
                            <i class="fas fa-exclamation-circle" style="color: #DC3545;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="ms-card">
        <div class="ms-card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h2 class="ms-card-title" style="margin: 0;">
                <i class="fas fa-receipt"></i> Receivables Overdue Register
            </h2>
            <div style="display: flex; gap: 8px;">
                <a asp-action="Create" class="ms-btn ms-btn-primary">
                    <i class="fas fa-plus"></i> Add Receivable
                </a>
                <button class="ms-btn ms-btn-warning" onclick="sendReminders()">
                    <i class="fas fa-bell"></i> Send Reminders
                </button>
                <button class="ms-btn ms-btn-info" onclick="generateReport()">
                    <i class="fas fa-file-pdf"></i> Report
                </button>
            </div>
        </div>
        <div class="ms-card-body">
            @if (Model != null && Model.Any())
            {
                <div class="table-responsive">
                    <table class="ms-datatable table table-striped table-hover" data-export="true" data-page-length="25">
                        <thead>
                            <tr>
                                <th>Sl.No</th>
                                <th>Invoice Date</th>
                                <th>Invoice No</th>
                                <th>Customer Name</th>
                                <th>Item Supplied</th>
                                <th>Invoice Amount</th>
                                <th>Amount Received</th>
                                <th>Balance Due</th>
                                <th>Due Date</th>
                                <th>Days Overdue</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.OrderByDescending(x => x.DaysOverdue))
                            {
                                <tr>
                                    <td>@item.Id</td>
                                    <td>@item.InvoiceDate.ToString("dd-MMM-yyyy")</td>
                                    <td>@item.InvoiceNumber</td>
                                    <td>@item.CustomerName</td>
                                    <td>@item.ItemSupplied</td>
                                    <td>₹ @item.InvoiceAmount.ToString("N2")</td>
                                    <td>₹ @item.AmountReceived.ToString("N2")</td>
                                    <td class="fw-bold text-danger">₹ @item.BalanceDue.ToString("N2")</td>
                                    <td>@item.DueDate.ToString("dd-MMM-yyyy")</td>
                                    <td>
                                        @if (item.DaysOverdue > 0)
                                        {
                                            <span class="ms-badge ms-badge-danger">@item.DaysOverdue days</span>
                                        }
                                        else
                                        {
                                            <span class="ms-badge ms-badge-success">On time</span>
                                        }
                                    </td>
                                    <td>
                                        @if (item.DaysOverdue > 60)
                                        {
                                            <span class="ms-badge ms-badge-danger">Critical</span>
                                        }
                                        else if (item.DaysOverdue > 30)
                                        {
                                            <span class="ms-badge ms-badge-warning">Overdue</span>
                                        }
                                        else
                                        {
                                            <span class="ms-badge ms-badge-info">Pending</span>
                                        }
                                    </td>
                                    <td>
                                        <div class="ms-action-buttons">
                                            <a asp-action="SendReminder" asp-route-id="@item.Id" class="ms-action-btn ms-action-btn-warning" title="Send Reminder">
                                                <i class="fas fa-envelope"></i>
                                            </a>
                                            <a asp-action="RecordPayment" asp-route-id="@item.Id" class="ms-action-btn ms-action-btn-success" title="Record Payment">
                                                <i class="fas fa-check"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-success text-center">
                    <i class="fas fa-thumbs-up fa-3x mb-3"></i>
                    <h5>All Receivables Collected!</h5>
                    <p>No pending receivables at this time.</p>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // DataTable initialization is handled by site-enhanced.js globally

        function sendReminders() {
            if (confirm('Send payment reminders to all overdue customers? This will send reminders to all customers with overdue payments.')) {
                // Create a form and submit it
                var form = document.createElement('form');
                form.method = 'POST';
                form.action = '@Url.Action("SendBulkReminders", "ReceivablesOverdue")';

                // Add anti-forgery token
                var token = document.querySelector('input[name="__RequestVerificationToken"]');
                if (token) {
                    var hiddenField = document.createElement('input');
                    hiddenField.type = 'hidden';
                    hiddenField.name = '__RequestVerificationToken';
                    hiddenField.value = token.value;
                    form.appendChild(hiddenField);
                }

                document.body.appendChild(form);
                form.submit();
            }
        }

        function generateReport() {
            // TODO: Implement PDF report generation for receivables
            if (confirm('Generate Receivables Report?')) {
                window.print(); // Temporary: use browser print
            }
        }
    </script>

    <style>
        /* Print styles - hide dashboard cards, show only table */
        @@media print {
            /* Hide dashboard stat cards */
            .row.mb-4:first-child {
                display: none !important;
            }

            /* Hide action buttons */
            .ms-card-header button,
            .ms-card-header a {
                display: none !important;
            }

            /* Hide send reminders button */
            button[onclick*="sendReminders"] {
                display: none !important;
            }

            /* Show only the table */
            .ms-card {
                box-shadow: none !important;
                border: none !important;
            }

            /* Ensure table is visible */
            table {
                display: table !important;
            }

            /* Add print header */
            @@page {
                margin: 1cm;
            }

            body::before {
                content: "Receivables Overdue Report - Printed on @DateTime.Now.ToString("dd-MMM-yyyy HH:mm")";
                display: block;
                text-align: center;
                font-weight: bold;
                margin-bottom: 20px;
                font-size: 16px;
            }
        }
    </style>

    <form style="display:none;">
        @Html.AntiForgeryToken()
    </form>
}