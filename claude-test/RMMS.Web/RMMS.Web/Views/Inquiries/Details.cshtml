@model RMMS.Models.Sales.Inquiry
@{
    ViewData["Title"] = "Inquiry Details";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-info-circle"></i> Inquiry Details</h2>
        <div>
            <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning">
                <i class="fas fa-edit"></i> Edit
            </a>
            <a asp-action="Index" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to List
            </a>
        </div>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="row">
        <div class="col-md-8">
            <!-- Main Inquiry Information -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Inquiry Information</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Inquiry Number:</strong>
                            <p class="text-primary fs-5">@Model.InquiryNumber</p>
                        </div>
                        <div class="col-md-6">
                            <strong>Inquiry Date:</strong>
                            <p>@Model.InquiryDate.ToString("dd MMMM yyyy")</p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Customer:</strong>
                            <p>@Model.Customer?.CustomerName (@Model.Customer?.CustomerCode)</p>
                        </div>
                        <div class="col-md-6">
                            <strong>Source:</strong>
                            <p><span class="badge bg-secondary">@Model.Source</span></p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <strong>Status:</strong>
                            @{
                                var statusClass = Model.Status switch
                                {
                                    "New" => "bg-primary",
                                    "In Progress" => "bg-warning",
                                    "Quoted" => "bg-info",
                                    "Converted" => "bg-success",
                                    "Lost" => "bg-danger",
                                    "Closed" => "bg-secondary",
                                    _ => "bg-secondary"
                                };
                            }
                            <p><span class="badge @statusClass fs-6">@Model.Status</span></p>
                        </div>
                        <div class="col-md-4">
                            <strong>Priority:</strong>
                            @{
                                var priorityClass = Model.Priority switch
                                {
                                    "Urgent" => "bg-danger",
                                    "High" => "bg-warning",
                                    "Normal" => "bg-info",
                                    "Low" => "bg-secondary",
                                    _ => "bg-secondary"
                                };
                            }
                            <p><span class="badge @priorityClass fs-6">@Model.Priority</span></p>
                        </div>
                        <div class="col-md-4">
                            <strong>Assigned To:</strong>
                            <p>@(Model.AssignedToEmployee?.EmployeeName ?? "Not Assigned")</p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Product Type:</strong>
                            <p>@Model.ProductType</p>
                        </div>
                        <div class="col-md-6">
                            <strong>Approximate Quantity:</strong>
                            <p>@Model.ApproximateQuantity</p>
                        </div>
                    </div>

                    <div class="mb-3">
                        <strong>Customer Requirements:</strong>
                        <p>@(Model.CustomerRequirements ?? "-")</p>
                    </div>

                    @if (!string.IsNullOrEmpty(Model.Remarks))
                    {
                        <div class="mb-3">
                            <strong>Remarks:</strong>
                            <p>@Model.Remarks</p>
                        </div>
                    }

                    @if (Model.Status == "Lost" && !string.IsNullOrEmpty(Model.LostReason))
                    {
                        <div class="alert alert-danger">
                            <strong>Lost Reason:</strong>
                            <p class="mb-0">@Model.LostReason</p>
                        </div>
                    }

                    @if (Model.FollowUpDate.HasValue)
                    {
                        <div class="mb-3">
                            <strong>Follow-Up Date:</strong>
                            <p class="@(Model.FollowUpDate < DateTime.Now ? "text-danger" : "text-success")">
                                @Model.FollowUpDate.Value.ToString("dd MMMM yyyy")
                                @if (Model.FollowUpDate < DateTime.Now)
                                {
                                    <span class="badge bg-danger">Overdue</span>
                                }
                            </p>
                        </div>
                    }

                    @if (Model.ConvertedToQuotationId.HasValue)
                    {
                        <div class="alert alert-success">
                            <strong>Converted to Quotation:</strong> Quotation ID #@Model.ConvertedToQuotationId
                        </div>
                    }
                </div>
            </div>

            <!-- Audit Information -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Audit Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Created On:</strong>
                            <p>@Model.CreatedDate.ToString("dd MMMM yyyy HH:mm:ss")</p>
                            <strong>Created By:</strong>
                            <p>@Model.CreatedBy</p>
                        </div>
                        <div class="col-md-6">
                            @if (Model.ModifiedDate.HasValue)
                            {
                                <strong>Last Modified:</strong>
                                <p>@Model.ModifiedDate.Value.ToString("dd MMMM yyyy HH:mm:ss")</p>
                                <strong>Modified By:</strong>
                                <p>@Model.ModifiedBy</p>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Quick Actions -->
            <div class="card mb-3">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    @if (Model.Status != "Converted" && Model.Status != "Lost" && Model.Status != "Closed")
                    {
                        <!-- Assign to Employee -->
                        <form asp-action="Assign" method="post" class="mb-2">
                            <input type="hidden" name="id" value="@Model.Id" />
                            <div class="mb-2">
                                <label class="form-label">Assign to Employee:</label>
                                <select name="employeeId" class="form-select form-select-sm">
                                    <option value="">Select Employee</option>
                                    @if (ViewBag.Employees != null)
                                    {
                                        @foreach (var employee in ViewBag.Employees)
                                        {
                                            <option value="@employee.Id" selected="@(Model.AssignedToEmployeeId == employee.Id)">
                                                @employee.EmployeeName
                                            </option>
                                        }
                                    }
                                </select>
                            </div>
                            <button type="submit" class="btn btn-sm btn-primary w-100">
                                <i class="fas fa-user"></i> Assign
                            </button>
                        </form>

                        <hr />

                        <!-- Update Follow-Up Date -->
                        <form asp-action="UpdateFollowUp" method="post" class="mb-2">
                            <input type="hidden" name="id" value="@Model.Id" />
                            <div class="mb-2">
                                <label class="form-label">Follow-Up Date:</label>
                                <input type="date" name="followUpDate" value="@Model.FollowUpDate?.ToString("yyyy-MM-dd")"
                                       class="form-control form-control-sm" />
                            </div>
                            <button type="submit" class="btn btn-sm btn-info w-100">
                                <i class="fas fa-calendar"></i> Update Follow-Up
                            </button>
                        </form>

                        <hr />

                        @if (Model.Status != "Lost")
                        {
                            <!-- Mark as Lost -->
                            <button type="button" class="btn btn-sm btn-danger w-100 mb-2" data-bs-toggle="modal" data-bs-target="#lostModal">
                                <i class="fas fa-times-circle"></i> Mark as Lost
                            </button>
                        }
                    }

                    @if (Model.Status == "Quoted" && !Model.ConvertedToQuotationId.HasValue)
                    {
                        <hr />
                        <button type="button" class="btn btn-sm btn-success w-100" onclick="alert('Quotation conversion functionality coming soon!')">
                            <i class="fas fa-file-invoice"></i> Convert to Quotation
                        </button>
                    }
                </div>
            </div>

            <!-- Customer Information -->
            @if (Model.Customer != null)
            {
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">Customer Details</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Code:</strong> @Model.Customer.CustomerCode</p>
                        <p><strong>Name:</strong> @Model.Customer.CustomerName</p>
                        <p><strong>Type:</strong> @Model.Customer.CustomerType</p>
                        @if (Model.Customer.GSTIN != null)
                        {
                            <p><strong>GSTIN:</strong> @Model.Customer.GSTIN</p>
                        }
                    </div>
                </div>
            }

            <!-- Activity Timeline (Placeholder) -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Activity Timeline</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item">
                            <i class="fas fa-circle text-primary"></i>
                            <p><small>Created on @Model.CreatedDate.ToString("dd MMM yyyy")</small></p>
                        </div>
                        @if (Model.ModifiedDate.HasValue)
                        {
                            <div class="timeline-item">
                                <i class="fas fa-circle text-info"></i>
                                <p><small>Last updated @Model.ModifiedDate.Value.ToString("dd MMM yyyy")</small></p>
                            </div>
                        }
                        @if (Model.ConvertedToQuotationId.HasValue)
                        {
                            <div class="timeline-item">
                                <i class="fas fa-circle text-success"></i>
                                <p><small>Converted to Quotation</small></p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mark as Lost Modal -->
<div class="modal fade" id="lostModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="MarkAsLost" method="post">
                <input type="hidden" name="id" value="@Model.Id" />
                <div class="modal-header">
                    <h5 class="modal-title">Mark Inquiry as Lost</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Reason for Lost:</label>
                        <textarea name="lostReason" class="form-control" rows="3" required
                                  placeholder="Enter reason why this inquiry was lost..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Mark as Lost</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <style>
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        .timeline-item {
            position: relative;
            padding-bottom: 15px;
        }
        .timeline-item i {
            position: absolute;
            left: -30px;
            top: 5px;
            font-size: 10px;
        }
    </style>
}
