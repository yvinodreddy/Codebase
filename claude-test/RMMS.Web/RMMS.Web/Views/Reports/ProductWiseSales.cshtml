@model RMMS.Models.ViewModels.ProductWiseSalesViewModel
@{
    ViewData["Title"] = "Product-wise Sales Report";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="card">
        <div class="card-header bg-warning text-dark">
            <h3><i class="fas fa-boxes"></i> Product-wise Sales Report</h3>
        </div>

        <div class="card-body">
            <!-- Summary Statistics -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h4>@Model.TotalProducts</h4>
                            <p class="mb-0">Total Products</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h4>₹ @Model.GrandTotalSales.ToString("N2")</h4>
                            <p class="mb-0">Total Sales Value</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h4>@Model.TotalQuantitySold.ToString("N2") kg</h4>
                            <p class="mb-0">Total Quantity Sold</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Performance Table -->
            <div class="table-responsive">
                <table class="ms-datatable table table-bordered table-hover" data-export="true" data-page-length="16">
                    <thead class="table-dark">
                        <tr>
                            <th>Product Name</th>
                            <th>Category</th>
                            <th>Total Quantity (kg)</th>
                            <th>Total Sales (₹)</th>
                            <th>Number of Sales</th>
                            <th>Average Price/kg</th>
                            <th>% of Total Sales</th>
                            <th>Performance</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.ProductGroups != null && Model.ProductGroups.Any())
                        {
                            decimal grandTotal = Model.GrandTotalSales > 0 ? Model.GrandTotalSales : 1;

                            foreach (var product in Model.ProductGroups)
                            {
                                decimal percentage = (product.TotalSales / grandTotal) * 100;
                                string performanceClass = percentage > 20 ? "success" : percentage > 10 ? "warning" : "secondary";

                                <tr>
                                    <td><strong>@product.ProductName</strong></td>
                                    <td>
                                        <span class="badge @(product.ProductCategory == "Rice" ? "bg-primary" : "bg-info")">
                                            @product.ProductCategory
                                        </span>
                                    </td>
                                    <td>@product.TotalQuantity.ToString("N2")</td>
                                    <td>₹ @product.TotalSales.ToString("N2")</td>
                                    <td>@product.NumberOfSales</td>
                                    <td>₹ @product.AveragePrice.ToString("N2")</td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-@performanceClass"
                                                 role="progressbar"
                                                 style="width: @percentage%"
                                                 aria-valuenow="@percentage"
                                                 aria-valuemin="0"
                                                 aria-valuemax="100">
                                                @percentage.ToString("N1")%
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        @if (percentage > 20)
                                        {
                                            <span class="badge bg-success">High Performer</span>
                                        }
                                        else if (percentage > 10)
                                        {
                                            <span class="badge bg-warning">Average</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Low</span>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="8" class="text-center" data-no-auto-dismiss>
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i> No product sales data available
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Product Analysis Charts -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Sales Distribution by Product</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="productChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>Rice vs By-Products Comparison</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="mt-4">
                <a href="@Url.Action("Index", "Reports")" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back
                </a>
                <button class="btn btn-primary" onclick="window.print()">
                    <i class="fas fa-print"></i> Print
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Convert the product groups to JSON for JavaScript consumption
        var productData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ProductGroups ?? new List<RMMS.Models.ViewModels.ProductSalesGroup>()));

        if (productData && productData.length > 0) {
            // Create the product sales bar chart
            var ctx1 = document.getElementById('productChart').getContext('2d');
            new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: productData.map(function(p) {
                        return p.ProductName || 'Unknown';
                    }),
                    datasets: [{
                        label: 'Sales Amount (₹)',
                        data: productData.map(function(p) {
                            return p.TotalSales || 0;
                        }),
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₹' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ₹' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // Calculate totals for rice and by-products
            var riceTotal = 0;
            var byProductTotal = 0;

            for (var i = 0; i < productData.length; i++) {
                if (productData[i].ProductCategory === 'Rice') {
                    riceTotal += (productData[i].TotalSales || 0);
                } else if (productData[i].ProductCategory === 'By-Product') {
                    byProductTotal += (productData[i].TotalSales || 0);
                }
            }

            // Create the category comparison doughnut chart
            var ctx2 = document.getElementById('categoryChart').getContext('2d');
            new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Rice Products', 'By-Products'],
                    datasets: [{
                        data: [riceTotal, byProductTotal],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(255, 206, 86, 0.8)'
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 206, 86, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    var label = context.label || '';
                                    var value = context.parsed || 0;
                                    var total = riceTotal + byProductTotal;
                                    var percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return label + ': ₹' + value.toLocaleString() + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
}