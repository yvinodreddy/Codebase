@model List<RMMS.Services.Interfaces.Production.YieldByMachineData>
@{
    ViewData["Title"] = "Yield by Machine";
    var fromDate = ViewBag.FromDate as DateTime?;
    var toDate = ViewBag.ToDate as DateTime?;
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-cog"></i> Yield by Machine</h2>
        <a asp-action="Index" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    <!-- Date Filter -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">From Date</label>
                    <input type="date" name="fromDate" class="form-control" value="@fromDate?.ToString("yyyy-MM-dd")" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">To Date</label>
                    <input type="date" name="toDate" class="form-control" value="@toDate?.ToString("yyyy-MM-dd")" />
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter"></i> Apply Filter
                    </button>
                </div>
            </form>
        </div>
    </div>

    @if (Model != null && Model.Any())
    {
        <!-- Machine Performance Chart -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Machine Performance Comparison</h5>
            </div>
            <div class="card-body">
                <canvas id="machineChart" height="80"></canvas>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Best Performing Machine</h6>
                        <h3 class="text-success">@Model.First().MachineName</h3>
                        <small class="text-muted">@Model.First().MachineCode</small>
                        <p class="mb-0 mt-2">Average Yield: <strong>@Model.First().AverageYieldPercent.ToString("F2")%</strong></p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-info">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Machines Used</h6>
                        <h3 class="text-info">@Model.Count</h3>
                        <p class="mb-0">In selected period</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-primary">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Overall Average</h6>
                        <h3 class="text-primary">@Model.Average(m => m.AverageYieldPercent).ToString("F2")%</h3>
                        <p class="mb-0">Across all machines</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Table -->
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-table"></i> Detailed Machine Analysis</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="ms-datatable table table-striped table-hover" data-export="true" data-page-length="16">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Machine</th>
                                <th>Machine Code</th>
                                <th>Batches Processed</th>
                                <th>Total Input (kg)</th>
                                <th>Total Output (kg)</th>
                                <th>Avg Yield %</th>
                                <th>Performance</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int rank = 1;
                                var overallAvg = Model.Average(m => m.AverageYieldPercent);
                                foreach (var machine in Model)
                                {
                                    var variance = machine.AverageYieldPercent - overallAvg;
                                    var performance = variance >= 2 ? "Excellent" : variance >= 0 ? "Good" : variance >= -2 ? "Average" : "Needs Attention";
                                    var badgeClass = variance >= 2 ? "bg-success" : variance >= 0 ? "bg-primary" : variance >= -2 ? "bg-warning" : "bg-danger";

                                    <tr>
                                        <td>
                                            @if (rank == 1)
                                            {
                                                <span class="badge bg-warning"><i class="fas fa-trophy"></i> @rank</span>
                                            }
                                            else
                                            {
                                                <strong>@rank</strong>
                                            }
                                        </td>
                                        <td><strong>@machine.MachineName</strong></td>
                                        <td><span class="badge bg-secondary">@machine.MachineCode</span></td>
                                        <td>@machine.BatchCount</td>
                                        <td>@machine.TotalInputQuantity.ToString("N0")</td>
                                        <td>@machine.TotalOutputQuantity.ToString("N0")</td>
                                        <td>
                                            <span class="badge @(machine.AverageYieldPercent >= 65 ? "bg-success" : machine.AverageYieldPercent >= 55 ? "bg-warning" : "bg-danger")">
                                                @machine.AverageYieldPercent.ToString("F2")%
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge @badgeClass">
                                                @performance
                                                @if (variance != 0)
                                                {
                                                    <span>(@(variance >= 0 ? "+" : "")@variance.ToString("F1")%)</span>
                                                }
                                            </span>
                                        </td>
                                    </tr>
                                    rank++;
                                }
                            }
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <td colspan="3"><strong>Overall Total</strong></td>
                                <td><strong>@Model.Sum(m => m.BatchCount)</strong></td>
                                <td><strong>@Model.Sum(m => m.TotalInputQuantity).ToString("N0")</strong></td>
                                <td><strong>@Model.Sum(m => m.TotalOutputQuantity).ToString("N0")</strong></td>
                                <td><strong>@Model.Average(m => m.AverageYieldPercent).ToString("F2")%</strong></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Recommendations -->
        var topMachine = Model.First();
        var bottomMachine = Model.Last();
        var gap = topMachine.AverageYieldPercent - bottomMachine.AverageYieldPercent;

        if (gap > 5)
        {
            <div class="alert alert-info mt-4">
                <h5><i class="fas fa-lightbulb"></i> Recommendations</h5>
                <p class="mb-0">
                    There is a <strong>@gap.ToString("F1")%</strong> yield gap between the best (@topMachine.MachineName) and lowest (@bottomMachine.MachineName) performing machines.
                    Consider scheduling maintenance for @bottomMachine.MachineName or reviewing operational procedures.
                </p>
            </div>
        }
    }
    else
    {
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> No machine data available for the selected period. Production orders must be assigned to machines to see this analysis.
        </div>
    }
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    @if (Model != null && Model.Any())
    {
        <script>
            var ctx = document.getElementById('machineChart').getContext('2d');
            var machineChart = new Chart(ctx, {
                type: 'horizontalBar',
                data: {
                    labels: [@Html.Raw(string.Join(",", Model.Select(m => $"'{m.MachineName}'")))],
                    datasets: [{
                        label: 'Average Yield %',
                        data: [@string.Join(",", Model.Select(m => m.AverageYieldPercent))],
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Machine Performance Comparison'
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: false,
                            min: 50,
                            max: 75,
                            title: {
                                display: true,
                                text: 'Average Yield %'
                            }
                        }
                    }
                }
            });
        </script>
    }
}
